<?xml version="1.0" encoding="UTF-8"?>
<!--
Azure API Management Policy for GitHub GraphQL API
This policy handles authentication and common error scenarios
-->
<policies>
  <inbound>
    <base />

    <authentication-managed-identity 
            resource="https://analysis.windows.net/powerbi/api" 
            client-id="{{managed_identity_client_id}}" 
            output-token-variable-name="token-variable" 
            ignore-error="false" />
    

    <set-header name="Authorization" exists-action="override">
            <value>@("Bearer " + (string)context.Variables["token-variable"])</value>
    </set-header>
    
    <set-header name="User-Agent" exists-action="override">
      <value>Azure-API-Management/1.0</value>
    </set-header>
    
    <!-- Set Content-Type for GraphQL -->
    <set-header name="Content-Type" exists-action="override">
      <value>application/json</value>
    </set-header>

    <!-- Trace incoming requests -->
    <trace source="InboundInformation" severity="error">
      @{
        return new JObject(
          new JProperty("timestamp", DateTime.UtcNow),
          new JProperty("status", "inbound"),
          new JProperty("operation", context.Operation.Name),
          new JProperty("requestId", context.RequestId),
          new JProperty("clientIP", context.Request.IpAddress),
          new JProperty("method", context.Request.Method),
          new JProperty("url", context.Request.Url.ToString()),
          new JProperty("headers", new JObject(
            new JProperty("User-Agent", context.Request.Headers.GetValueOrDefault("User-Agent", "Unknown")),
            new JProperty("Content-Type", context.Request.Headers.GetValueOrDefault("Content-Type", "Unknown"))
          ))
        ).ToString();
      }
    </trace>
  </inbound>
  
  <backend>
    <base />
  </backend>
  
  <outbound>
    <base />
    <!-- Trace successful responses -->
    <trace source="OutboundInformation" severity="error">
      @{
        return new JObject(
          new JProperty("timestamp", DateTime.UtcNow),
          new JProperty("status", "success"),
          new JProperty("statusCode", context.Response.StatusCode),
          new JProperty("operation", context.Operation.Name),
          new JProperty("responseHeaders", new JObject(
            new JProperty("X-RateLimit-Remaining", context.Response.Headers.GetValueOrDefault("X-RateLimit-Remaining", "Unknown")),
            new JProperty("X-RateLimit-Reset", context.Response.Headers.GetValueOrDefault("X-RateLimit-Reset", "Unknown"))
          ))
        ).ToString();
      }
    </trace>
 
    
  </outbound>
  
  <on-error>
    <base />
    
    <!-- Enhanced error handling for GitHub API -->
    <choose>
      
      <!-- Authentication errors -->
      <when condition="@(context.Response.StatusCode == 401)">
        <set-variable name="errorMessage" value="GitHub authentication failed. Please check your access token." />
        <set-header name="Content-Type" exists-action="override">
          <value>application/json</value>
        </set-header>
        <set-body>@{
          return new JObject(
            new JProperty("errors", new JArray(
              new JObject(
                new JProperty("message", context.Variables.GetValueOrDefault<string>("errorMessage")),
                new JProperty("extensions", new JObject(
                  new JProperty("code", "UNAUTHENTICATED"),
                  new JProperty("timestamp", DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ssZ"))
                ))
              )
            ))
          ).ToString();
        }</set-body>
      </when>
      
      <!-- Permission/Forbidden errors -->
      <when condition="@(context.Response.StatusCode == 403)">
        <set-variable name="errorMessage" value="Insufficient permissions or rate limit exceeded." />
        <set-header name="Content-Type" exists-action="override">
          <value>application/json</value>
        </set-header>
        <set-body>@{
          return new JObject(
            new JProperty("errors", new JArray(
              new JObject(
                new JProperty("message", context.Variables.GetValueOrDefault<string>("errorMessage")),
                new JProperty("extensions", new JObject(
                  new JProperty("code", "FORBIDDEN"),
                  new JProperty("rateLimitRemaining", context.Response.Headers.GetValueOrDefault("X-RateLimit-Remaining", "Unknown")),
                  new JProperty("timestamp", DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ssZ"))
                ))
              )
            ))
          ).ToString();
        }</set-body>
      </when>
      
      <!-- Rate limit errors -->
      <when condition="@(context.Response.StatusCode == 429)">
        <set-variable name="retryAfter" value="@(context.Response.Headers.GetValueOrDefault("Retry-After", "3600"))" />
        <set-header name="Content-Type" exists-action="override">
          <value>application/json</value>
        </set-header>
        <set-body>@{
          return new JObject(
            new JProperty("errors", new JArray(
              new JObject(
                new JProperty("message", "Rate limit exceeded. Please try again later."),
                new JProperty("extensions", new JObject(
                  new JProperty("code", "RATE_LIMITED"),
                  new JProperty("retryAfter", context.Variables.GetValueOrDefault<string>("retryAfter")),
                  new JProperty("timestamp", DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ssZ"))
                ))
              )
            ))
          ).ToString();
        }</set-body>
      </when>
      
      <!-- Server errors -->
      <when condition="@(context.Response.StatusCode >= 500)">
        <set-header name="Content-Type" exists-action="override">
          <value>application/json</value>
        </set-header>
        <set-body>@{
          return new JObject(
            new JProperty("errors", new JArray(
              new JObject(
                new JProperty("message", "GitHub GraphQL API is temporarily unavailable."),
                new JProperty("extensions", new JObject(
                  new JProperty("code", "INTERNAL_ERROR"),
                  new JProperty("timestamp", DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ssZ"))
                ))
              )
            ))
          ).ToString();
        }</set-body>
      </when>
      
    </choose>
    
    <!-- Trace all errors -->
    <trace source="ErrorInformation" severity="error">
      @{
        return new JObject(
          new JProperty("timestamp", DateTime.UtcNow),
          new JProperty("status", "error"),
          new JProperty("statusCode", context.Response.StatusCode),
          new JProperty("error", context.LastError?.Message ?? "Unknown error"),
          new JProperty("operation", context.Operation.Name)
        ).ToString();
      }
    </trace>
    
  </on-error>
  
</policies>